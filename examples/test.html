<!DOCTYPE html>
<html>
<head><title>vertebrate.js Example</title>
<style>
input[name="mi"],input[name="age"],input[name="state"] {
    width:30px;
}
input[name="zip"] {
    width:40px;
}
</style>
</head>
<body>

<table>
    <thead>
        <tr><th colspan="3">Name</th><th>Age</th><th colspan="4">Address</th><th>E-mail</th><th colspan="2"><button type="button" id="addRow">Add</button></th></tr>
    </thead>
    <tbody></tbody>
</table>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>
<script src="../vertebrate.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.8.3/underscore-min.js"></script>
<script>

// Simple JavaScript Templating
// John Resig - http://ejohn.org/ - MIT Licensed
(function(){
  var cache = {};

  this.tmpl = function tmpl(str, data){
    // Figure out if we're getting a template, or if we need to
    // load the template - and be sure to cache the result.
    var fn = !/\W/.test(str) ?
      cache[str] = cache[str] ||
        tmpl(document.getElementById(str).innerHTML) :

      // Generate a reusable function that will serve as a template
      // generator (and which will be cached).
      new Function("obj",
        "var p=[],print=function(){p.push.apply(p,arguments);};" +

        // Introduce the data as local variables using with(){}
        "with(obj){p.push('" +

        // Convert the template into pure JavaScript
        str
          .replace(/[\r\t\n]/g, " ")
          .split("<%").join("\t")
          .replace(/((^|%>)[^\t]*)'/g, "$1\r")
          .replace(/\t=(.*?)%>/g, "',$1,'")
          .split("\t").join("');")
          .split("%>").join("p.push('")
          .split("\r").join("\\'")
      + "');}return p.join('');");

    // Provide some basic currying to the user
    return data ? fn( data ) : fn;
  };
})();

Vertebrate.set('url','php/handler.php');

var player = Vertebrate.Model.Extend({
    attributes: {
        id: 0,
        first_name: '',
        mi: '',
        last_name: '',
        age: 0,
        address: '',
        city: '',
        state: '',
        zip: '',
        email: ''
    }
});

var team = Vertebrate.Collection.Extend({
    model: player,
    attributes: {
        orderBy: 'last_name, first_name'
    }
});

var ourteam = new team();

$('body').on('vertebrate.changeattr',function(a,b,c,d) {
    //console.log(a);
    //console.log(b);
    //console.log(c);
    //console.log(d);
});

$('body').on('vertebrate.removed',function(a,b,c) {
    //console.log(a);
    //console.log(b);
    //console.log(c);
})

var promise = ourteam.fetch();
$.when(promise).done(function() {
    ourteam.render();
    model = ourteam.find(1);
    //model.set('crn',12345);
    model.get('crn');
})

ourteam.render = function( ) {
    $('table tbody').empty();
    $.each(this.models,function(k,v) {
        $('table tbody').append(tmpl('player_tmpl',v.attributes))
    })
}

$('body').on('change','input',function() {
    var model = ourteam.find($(this).closest('tr').data('modelid'),'id');
    model.set($(this).attr('name'),$(this).val());
});

$('body').on('click','.save',function() {
    var model = ourteam.find($(this).closest('tr').data('modelid'),'id');
    console.log(model);
    model.save();
    ourteam.render();
});

$('body').on('click','.delete',function() {
    var tr = $(this).closest('tr');
    var model = ourteam.find(tr.data('modelid'),'id');
    console.log(model);
    model.delete(function() {
        ourteam.remove(model);
        tr.remove();
    });
});

$('#addRow').click(function() {
    ourteam.add(new player());
    ourteam.render();
});


</script>

<script type="text/html" id="player_tmpl">
    <tr data-modelid='<%=id%>'>
        <td><input type="text" name="first_name" value="<%=first_name%>"></td>
        <td><input type="text" name="mi" value="<%=mi%>"></td>
        <td><input type="text" name="last_name" value="<%=last_name%>"></td>
        <td><input type="text" name="age" value="<%=age%>"></td>
        <td><input type="text" name="address" value="<%=address%>"></td>
        <td><input type="text" name="city" value="<%=city%>"></td>
        <td><input type="text" name="state" value="<%=state%>"></td>
        <td><input type="text" name="zip" value="<%=zip%>"></td>
        <td><input type="text" name="email" value="<%=email%>"></td>
        <td><button type="button" class="save">Save</button></td>
        <td><button type="button" class="delete">Delete</button></td>
    </tr>
</script>

</body>
</html>
